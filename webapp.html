<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <title>PaySwap Wallet</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #f5f5f5);
            color: var(--tg-theme-text-color, #000000);
            padding: 16px;
            margin: 0;
        }
        
        .header {
            text-align: center;
            margin-bottom: 24px;
        }
        
        .header h1 {
            font-size: 24px;
            color: var(--tg-theme-button-color, #2AABEE);
            margin-bottom: 8px;
        }
        
        .prices-card {
            background: var(--tg-theme-secondary-bg-color, #ffffff);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .price-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .price-item:last-child {
            border-bottom: none;
        }
        
        .pair {
            font-weight: 600;
        }
        
        .value {
            font-size: 18px;
            font-weight: 700;
        }
        
        .button {
            background: var(--tg-theme-button-color, #2AABEE);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 12px;
            padding: 16px;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
            margin-bottom: 12px;
        }
        
        .result-card {
            background: var(--tg-theme-secondary-bg-color, #ffffff);
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }
        
        .result-card.show {
            display: block;
        }
        
        .rub-amount {
            font-size: 32px;
            font-weight: 700;
            color: var(--tg-theme-button-color, #2AABEE);
            text-align: center;
            margin: 10px 0;
        }
        
        .usdt-amount {
            font-size: 28px;
            font-weight: 700;
            text-align: center;
            margin: 10px 0;
        }
        
        .details {
            background: rgba(0,0,0,0.03);
            padding: 12px;
            border-radius: 8px;
            margin-top: 16px;
            font-size: 14px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loading.show {
            display: block;
        }
        
        .error {
            color: #d63031;
            text-align: center;
            padding: 16px;
            display: none;
        }
        
        .error.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üí∞ PaySwap Wallet</h1>
        <p>–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –¥–ª—è –æ–ø–ª–∞—Ç—ã –≤ USDT</p>
    </div>
    
    <!-- –ö—É—Ä—Å—ã –≤–∞–ª—é—Ç -->
    <div class="prices-card">
        <h3 style="margin-bottom: 8px;">üìä –ö—É—Ä—Å—ã Rapira</h3>
        <div id="pricesContainer">
            <div class="loading show" id="pricesLoading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫—É—Ä—Å–æ–≤...</div>
        </div>
    </div>
    
    <!-- –ö–Ω–æ–ø–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <button class="button" id="scanBtn">
        üì∏ –°–ö–ê–ù–ò–†–û–í–ê–¢–¨ QR-–ö–û–î
    </button>
    
    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
    <div class="result-card" id="resultCard">
        <h3 style="text-align: center;">‚úÖ –ì–û–¢–û–í–û</h3>
        <div class="rub-amount" id="rubAmount">0 ‚ÇΩ</div>
        <div class="usdt-amount" id="usdtAmount">0 USDT</div>
        <div class="details" id="details"></div>
        <button class="button" id="newScanBtn" style="margin-top: 16px;">
            üîÑ –ù–û–í–´–ô –ü–õ–ê–¢–ï–ñ
        </button>
    </div>
    
    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
    <div class="loading" id="loading">
        ‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ QR-–∫–æ–¥–∞...
    </div>
    
    <!-- –û—à–∏–±–∫–∞ -->
    <div class="error" id="error"></div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        let tg = window.Telegram.WebApp;
        tg.expand(); // –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
        tg.ready();
        
        // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
		const API_BASE = 'https://payswap-bot.onrender.com';
        const scanBtn = document.getElementById('scanBtn');
        const newScanBtn = document.getElementById('newScanBtn');
        const resultCard = document.getElementById('resultCard');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const rubAmount = document.getElementById('rubAmount');
        const usdtAmount = document.getElementById('usdtAmount');
        const details = document.getElementById('details');
        const pricesContainer = document.getElementById('pricesContainer');
        const pricesLoading = document.getElementById('pricesLoading');
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫—É—Ä—Å—ã –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
        loadPrices();
        
        // –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR
        scanBtn.addEventListener('click', () => {
    tg.showScanQrPopup({
        text: '–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥ –æ–ø–ª–∞—Ç—ã'
    }, (result) => {  // <- –º–µ–Ω—è–µ–º qrData –Ω–∞ result
        if (!result) return;  // –µ—Å–ª–∏ –∑–∞–∫—Ä—ã–ª–∏ –±–µ–∑ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        
        console.log("QR –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω:", result);
        processQR(result);  // –ø–µ—Ä–µ–¥–∞–µ–º result –≤ —Ñ—É–Ω–∫—Ü–∏—é
    });
});
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
                loading.classList.add('show');
                resultCard.classList.remove('show');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º QR –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                fetch(API_BASE + '/api/prices'), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({qr: qrData})
                }
                .then(res => res.json())
                .then(data => {
                    loading.classList.remove('show');
                    
                    if (data.success) {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                        rubAmount.textContent = `${data.rub.toFixed(2)} ‚ÇΩ`;
                        usdtAmount.textContent = `${data.usdt} USDT`;
                        
                        details.innerHTML = `
                            <div>üìà –ö—É—Ä—Å –±–∏—Ä–∂–∏: ${data.rate} ‚ÇΩ/USDT</div>
                            <div>üí∞ –ö—É—Ä—Å —Å–ø–∏—Å–∞–Ω–∏—è: ${data.rate_with_markup} ‚ÇΩ/USDT (+5%)</div>
                            <div style="margin-top:8px; color:#666; font-size:12px; word-break:break-all;">
                                QR: ${data.qr}
                            </div>
                        `;
                        
                        resultCard.classList.add('show');
                        
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É
                        tg.sendData(JSON.stringify({
                            type: 'qr_scan',
                            user: tg.initDataUnsafe?.user,
                            qr: qrData,
                            rub: data.rub,
                            usdt: data.usdt
                        }));
                        
                    } else {
                        showError(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å—É–º–º—É');
                    }
                })
                .catch(err => {
                    loading.classList.remove('show');
                    showError('–û—à–∏–±–∫–∞: ' + err.message);
                });
        
        // –ù–æ–≤–∞—è –æ–ø–ª–∞—Ç–∞
        newScanBtn.addEventListener('click', () => {
            resultCard.classList.remove('show');
        });
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫—É—Ä—Å–æ–≤
        async function loadPrices() {
    try {
        console.log("–ó–∞–≥—Ä—É–∑–∫–∞ –∫—É—Ä—Å–æ–≤...");
        const res = await fetch('/api/prices');
        console.log("–û—Ç–≤–µ—Ç:", res.status);
        
        if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
        }
        
        const data = await res.json();
        console.log("–î–∞–Ω–Ω—ã–µ:", data);
        
        const container = document.getElementById('pricesContainer');
        
        if (data.prices && data.prices.length > 0) {
            container.innerHTML = '';
            data.prices.forEach(item => {
                const changeClass = item.change > 0 ? 'positive' : (item.change < 0 ? 'negative' : '');
                const changeSign = item.change > 0 ? '+' : '';
                
                container.innerHTML += `
                    <div class="price-item">
                        <span class="pair">${item.pair}</span>
                        <span>
                            <span class="value">${item.price}</span>
                            <span style="margin-left:8px; color:${item.change > 0 ? '#00b894' : (item.change < 0 ? '#d63031' : '#666')}">
                                ${changeSign}${item.change}%
                            </span>
                        </span>
                    </div>
                `;
            });
        } else {
            container.innerHTML = '<div style="color:#666">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
        }
    } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—É—Ä—Å–æ–≤:", err);
        document.getElementById('pricesContainer').innerHTML = 
            '<div style="color:#d63031">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + err.message + '</div>';
    }
}
// –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ QR-–∫–æ–¥–∞
async function processQR(qrData) {
    // –ö–∞–º–µ—Ä–∞ —É–∂–µ –∑–∞–∫—Ä–æ–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    // –ü—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    loading.classList.add('show');
    resultCard.classList.remove('show');
    
    try {
        const res = await fetch('/api/parse-qr', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({qr: qrData})
        });
        
        const data = await res.json();
        loading.classList.remove('show');
        
        if (data.success) {
            rubAmount.textContent = `${data.rub.toFixed(2)} ‚ÇΩ`;
            usdtAmount.textContent = `${data.usdt} USDT`;
            
            details.innerHTML = `
                <div>üìà –ö—É—Ä—Å –±–∏—Ä–∂–∏: ${data.rate} ‚ÇΩ/USDT</div>
                <div>üí∞ –ö—É—Ä—Å —Å–ø–∏—Å–∞–Ω–∏—è: ${data.rate_with_markup} ‚ÇΩ/USDT (+5%)</div>
                <div style="margin-top:8px; color:#666; font-size:12px; word-break:break-all;">
                    QR: ${data.qr}
                </div>
            `;
            
            resultCard.classList.add('show');
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–¥–º–∏–Ω—É —á–µ—Ä–µ–∑ –±–æ—Ç–∞
            if (tg) {
                tg.sendData(JSON.stringify({
                    type: 'qr_scan',
                    user: tg.initDataUnsafe?.user,
                    qr: qrData,
                    rub: data.rub,
                    usdt: data.usdt
                }));
                console.log("–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –±–æ—Ç—É");
            }
        } else {
            showError(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å—É–º–º—É');
        }
    } catch (err) {
        loading.classList.remove('show');
        showError('–û—à–∏–±–∫–∞: ' + err.message);
        console.error(err);
    }
}
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
        function showError(msg) {
            error.textContent = msg;
            error.classList.add('show');
            setTimeout(() => {
                error.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>